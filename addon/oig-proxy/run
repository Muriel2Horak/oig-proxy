#!/usr/bin/with-contenv bashio

# DNS override: oigservis.cz -> HA IP (robust fallback chain)
HA_IP_RAW=$(bashio::config 'ha_ip')
if [ -z "$HA_IP_RAW" ] || [ "$HA_IP_RAW" = "null" ]; then
  HA_IP_RAW=$(ip -4 route get 8.8.8.8 2>/dev/null | awk '{print $7; exit}')
fi
if [ -z "$HA_IP_RAW" ]; then
  HA_IP_RAW=$(hostname -I 2>/dev/null | awk '{print $1}')
fi
# valid IPv4 check; otherwise fallback
if echo "$HA_IP_RAW" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
  HA_IP="$HA_IP_RAW"
else
  HA_IP="127.0.0.1"
fi

UPSTREAM=$(bashio::config 'dns_upstream' | tr -d '[]"' | xargs)
if [ -z "$UPSTREAM" ] || [ "$UPSTREAM" = "null" ]; then
  UPSTREAM="8.8.8.8"
fi
if ! echo "$UPSTREAM" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
  UPSTREAM="8.8.8.8"
fi

echo "server=$UPSTREAM" > /etc/dnsmasq.d/upstream.conf
echo "address=/oigservis.cz/$HA_IP" > /etc/dnsmasq.d/oig.conf

# spustit dnsmasq (foreground &)
/usr/sbin/dnsmasq -k --conf-dir=/etc/dnsmasq.d &

# Připravit JSON mapu: pokud chybí v /data, zkopíruj default z /app
if [ ! -f /data/sensor_map.json ] && [ -f /app/sensor_map.json ]; then
  cp /app/sensor_map.json /data/sensor_map.json
fi

# Env pro proxy
export TARGET_SERVER=$(bashio::config 'target_server')
export TARGET_PORT=$(bashio::config 'target_port')
export PROXY_PORT=$(bashio::config 'proxy_port')
export MQTT_HOST=$(bashio::config 'mqtt_host')
export MQTT_PORT=$(bashio::config 'mqtt_port')
export MQTT_USERNAME=$(bashio::config 'mqtt_username')
export MQTT_PASSWORD=$(bashio::config 'mqtt_password')
export MAP_RELOAD_SECONDS=$(bashio::config 'map_reload_seconds')
# log_level může být string nebo list -> vezmeme první hodnotu
LOG_LEVEL_RAW=$(bashio::config 'log_level' | tr -d '[]\"' | xargs | cut -d',' -f1)
[ -z "$LOG_LEVEL_RAW" ] && LOG_LEVEL_RAW="INFO"
export LOG_LEVEL=$LOG_LEVEL_RAW
export DISCOVERY_SUFFIX=$(bashio::config 'discovery_suffix')
export SENSOR_MAP_PATH=/data/sensor_map.json
export UNKNOWN_SENSORS_PATH=/data/unknown_sensors.json

python -u /app/main.py
