#!/usr/bin/with-contenv bashio

# DNS override: oigservis.cz -> HA IP (robust fallback chain)
HA_IP_RAW=$(bashio::config 'ha_ip')
if [ -z "$HA_IP_RAW" ] || [ "$HA_IP_RAW" = "null" ]; then
  HA_IP_RAW=$(ip -4 route get 8.8.8.8 2>/dev/null | awk '{print $7; exit}')
fi
if [ -z "$HA_IP_RAW" ]; then
  HA_IP_RAW=$(hostname -I 2>/dev/null | awk '{print $1}')
fi
# valid IPv4 check; otherwise fallback
if echo "$HA_IP_RAW" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
  HA_IP="$HA_IP_RAW"
else
  HA_IP="127.0.0.1"
fi

UPSTREAM=$(bashio::config 'dns_upstream' | tr -d '[]"' | xargs)
if [ -z "$UPSTREAM" ] || [ "$UPSTREAM" = "null" ]; then
  UPSTREAM="8.8.8.8"
fi
if ! echo "$UPSTREAM" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
  UPSTREAM="8.8.8.8"
fi

echo "server=$UPSTREAM" > /etc/dnsmasq.d/upstream.conf
echo "address=/oigservis.cz/$HA_IP" > /etc/dnsmasq.d/oig.conf

# spustit dnsmasq (foreground &)
/usr/sbin/dnsmasq -k --conf-dir=/etc/dnsmasq.d &

# Připravit JSON mapu: vždy použij novou verzi z image (release)
if [ -f /data/sensor_map.json ]; then
  cp /data/sensor_map.json /data/sensor_map.json.bak.$(date +%s) || true
fi
cp /app/sensor_map.json /data/sensor_map.json

# Env pro proxy
export TARGET_SERVER=$(bashio::config 'target_server')
export TARGET_PORT=$(bashio::config 'target_port')
export PROXY_PORT=$(bashio::config 'proxy_port')
export MQTT_HOST=$(bashio::config 'mqtt_host')
export MQTT_PORT=$(bashio::config 'mqtt_port')
export MQTT_USERNAME=$(bashio::config 'mqtt_username')
export MQTT_PASSWORD=$(bashio::config 'mqtt_password')
export MAP_RELOAD_SECONDS=$(bashio::config 'map_reload_seconds')

# NOVÉ: DEVICE_ID (volitelné, pokud není v config, použije se auto-detection)
DEVICE_ID_RAW=$(bashio::config 'device_id' 2>/dev/null)
if [ ! -z "$DEVICE_ID_RAW" ] && [ "$DEVICE_ID_RAW" != "null" ]; then
  export DEVICE_ID="$DEVICE_ID_RAW"
  bashio::log.info "Using configured DEVICE_ID: $DEVICE_ID"
else
  bashio::log.info "DEVICE_ID not configured, will be auto-detected from BOX communication"
fi

# log_level může být string nebo list -> vezmeme první hodnotu
LOG_LEVEL_RAW=$(bashio::config 'log_level' | tr -d '[]\"' | xargs | cut -d',' -f1)
[ -z "$LOG_LEVEL_RAW" ] && LOG_LEVEL_RAW="INFO"
export LOG_LEVEL=$LOG_LEVEL_RAW
export SENSOR_MAP_PATH=/data/sensor_map.json
export UNKNOWN_SENSORS_PATH=/data/unknown_sensors.json
export CAPTURE_PAYLOADS=$(bashio::config 'capture_payloads')

python -u /app/main.py
