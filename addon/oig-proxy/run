#!/usr/bin/with-contenv bashio

# DNS override: oigservis.cz -> HA IP (robust fallback chain)
HA_IP_RAW=$(bashio::config 'ha_ip')
if [ -z "$HA_IP_RAW" ] || [ "$HA_IP_RAW" = "null" ]; then
  HA_IP_RAW=$(ip -4 route get 8.8.8.8 2>/dev/null | awk '{print $7; exit}')
fi
if [ -z "$HA_IP_RAW" ]; then
  HA_IP_RAW=$(hostname -I 2>/dev/null | awk '{print $1}')
fi
# valid IPv4 check; otherwise fallback
if echo "$HA_IP_RAW" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
  HA_IP="$HA_IP_RAW"
else
  HA_IP="127.0.0.1"
fi

UPSTREAM=$(bashio::config 'dns_upstream' | tr -d '[]"' | xargs)
if [ -z "$UPSTREAM" ] || [ "$UPSTREAM" = "null" ]; then
  UPSTREAM="8.8.8.8"
fi
if ! echo "$UPSTREAM" | grep -Eq '^[0-9]{1,3}(\.[0-9]{1,3}){3}$'; then
  UPSTREAM="8.8.8.8"
fi

echo "server=$UPSTREAM" > /etc/dnsmasq.d/upstream.conf
echo "address=/oigservis.cz/$HA_IP" > /etc/dnsmasq.d/oig.conf

# spustit dnsmasq (foreground &)
/usr/sbin/dnsmasq -k --conf-dir=/etc/dnsmasq.d &

# PÅ™ipravit JSON mapu: vÅ¾dy pouÅ¾ij novou verzi z image (release)
if [ -f /data/sensor_map.json ]; then
  cp /data/sensor_map.json /data/sensor_map.json.bak.$(date +%s) || true
fi
cp /app/sensor_map.json /data/sensor_map.json

# Env pro proxy
export TARGET_SERVER=$(bashio::config 'target_server')
export TARGET_PORT=$(bashio::config 'target_port')

CLOUD_ACK_TIMEOUT_RAW=$(bashio::config 'cloud_ack_timeout')
if [ -z "$CLOUD_ACK_TIMEOUT_RAW" ] || [ "$CLOUD_ACK_TIMEOUT_RAW" = "null" ]; then
  CLOUD_ACK_TIMEOUT_RAW=3.0
fi
export CLOUD_ACK_TIMEOUT=$CLOUD_ACK_TIMEOUT_RAW

export PROXY_PORT=$(bashio::config 'proxy_port')
export MQTT_HOST=$(bashio::config 'mqtt_host')
export MQTT_PORT=$(bashio::config 'mqtt_port')
export MQTT_USERNAME=$(bashio::config 'mqtt_username')
export MQTT_PASSWORD=$(bashio::config 'mqtt_password')
export MAP_RELOAD_SECONDS=$(bashio::config 'map_reload_seconds')

PROXY_STATUS_INTERVAL_RAW=$(bashio::config 'proxy_status_interval')
if [ -z "$PROXY_STATUS_INTERVAL_RAW" ] || [ "$PROXY_STATUS_INTERVAL_RAW" = "null" ]; then
  PROXY_STATUS_INTERVAL_RAW=60
fi
export PROXY_STATUS_INTERVAL=$PROXY_STATUS_INTERVAL_RAW

# NOVÃ‰: DEVICE_ID (volitelnÃ©, pokud nenÃ­ v config, pouÅ¾ije se auto-detection)
DEVICE_ID_RAW=$(bashio::config 'device_id' 2>/dev/null)
if [ ! -z "$DEVICE_ID_RAW" ] && [ "$DEVICE_ID_RAW" != "null" ]; then
  export DEVICE_ID="$DEVICE_ID_RAW"
  bashio::log.info "Using configured DEVICE_ID: $DEVICE_ID"
else
  bashio::log.info "DEVICE_ID not configured, will be auto-detected from BOX communication"
fi

# log_level mÅ¯Å¾e bÃ½t string nebo list -> vezmeme prvnÃ­ hodnotu
LOG_LEVEL_RAW=$(bashio::config 'log_level' | tr -d '[]\"' | xargs | cut -d',' -f1)
[ -z "$LOG_LEVEL_RAW" ] && LOG_LEVEL_RAW="INFO"
export LOG_LEVEL=$LOG_LEVEL_RAW
export SENSOR_MAP_PATH=/data/sensor_map.json
export UNKNOWN_SENSORS_PATH=/data/unknown_sensors.json

# CAPTURE_PAYLOADS - boolean z config
CAPTURE_RAW=$(bashio::config 'capture_payloads')
if [ "$CAPTURE_RAW" = "true" ] || [ "$CAPTURE_RAW" = "1" ]; then
  export CAPTURE_PAYLOADS="true"
  bashio::log.info "ðŸ“‹ Capture payloads: ENABLED"
else
  export CAPTURE_PAYLOADS="false"
  bashio::log.info "ðŸ“‹ Capture payloads: DISABLED"
fi

# CAPTURE_RAW_BYTES - boolean z config (uklÃ¡dÃ¡ base64 raw bytes do payloads.db)
CAPTURE_RAW_BYTES=$(bashio::config 'capture_raw_bytes' 2>/dev/null)
if [ "$CAPTURE_RAW_BYTES" = "true" ] || [ "$CAPTURE_RAW_BYTES" = "1" ]; then
  export CAPTURE_RAW_BYTES="true"
  bashio::log.info "ðŸ“¦ Capture raw bytes: ENABLED"
else
  export CAPTURE_RAW_BYTES="false"
  bashio::log.info "ðŸ“¦ Capture raw bytes: DISABLED"
fi

python -u /app/main.py
