#!/usr/bin/with-contenv bashio

# DNS override: oigservis.cz -> HA IP
HA_IP=$(bashio::config 'ha_ip')
if [ -z "$HA_IP" ]; then
  # Fallback: first host IP
  HA_IP=$(hostname -I | awk '{print $1}')
fi
UPSTREAM=$(bashio::config 'dns_upstream' | tr -d '[]"' | xargs)
if [ -z "$UPSTREAM" ]; then
  UPSTREAM="8.8.8.8"
fi

echo "server=$UPSTREAM" > /etc/dnsmasq.d/upstream.conf
echo "address=/oigservis.cz/$HA_IP" > /etc/dnsmasq.d/oig.conf

# spustit dnsmasq (foreground &)
/usr/sbin/dnsmasq -k --conf-dir=/etc/dnsmasq.d &

# Env pro proxy
export TARGET_SERVER=$(bashio::config 'target_server')
export TARGET_PORT=$(bashio::config 'target_port')
export PROXY_PORT=$(bashio::config 'proxy_port')
export MQTT_HOST=$(bashio::config 'mqtt_host')
export MQTT_PORT=$(bashio::config 'mqtt_port')
export MQTT_USERNAME=$(bashio::config 'mqtt_username')
export MQTT_PASSWORD=$(bashio::config 'mqtt_password')
export MAP_RELOAD_SECONDS=$(bashio::config 'map_reload_seconds')
export SENSOR_MAP_PATH=/data/sensor_map.json
export UNKNOWN_SENSORS_PATH=/data/unknown_sensors.json

python -u /app/main.py
