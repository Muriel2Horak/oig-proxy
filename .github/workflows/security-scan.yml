name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install bandit safety
      
      - name: Install Semgrep
        run: |
          python -m pip install semgrep
      
      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
      
      - name: Create reports directory
        run: mkdir -p reports
      
      - name: Run Gitleaks (Secret leak detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
      
      - name: Run Bandit (Python SAST)
        run: |
          python -m bandit -r addon/oig-proxy -f json -o reports/bandit.json --exit-zero
        continue-on-error: true
      
      - name: Run Safety (Dependency vulnerabilities)
        run: |
          python -m safety check -r addon/oig-proxy/requirements.txt --json --output reports/safety.json || true
        continue-on-error: true
      
      - name: Run Semgrep (Advanced SAST)
        run: |
          semgrep --config=auto --json --output reports/semgrep.json addon/oig-proxy || true
        continue-on-error: true
      
      - name: Run Trivy (Container and dependency scanning)
        run: |
          trivy filesystem --quiet --security-checks vuln,license --format json --output reports/trivy.json addon/oig-proxy || true
        continue-on-error: true
      
      
      - name: Run security unit tests
        run: |
          python -m pytest tests/test_security.py -v --junitxml=reports/security-junit.xml
        env:
          PYTHONPATH: addon/oig-proxy
      
      - name: Run penetration tests
        run: |
          python -m pytest tests/test_penetration.py -v --junitxml=reports/penetration-junit.xml
        env:
          PYTHONPATH: addon/oig-proxy
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: reports/bandit.json
      
      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: reports/safety.json
      
      - name: Upload Semgrep report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-report
          path: reports/semgrep.json
      
      - name: Upload Trivy report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: reports/trivy.json

      - name: Upload Gitleaks report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks.sarif
      
      
      - name: Upload security test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-tests-report
          path: reports/security-junit.xml
      
      - name: Upload penetration test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: penetration-tests-report
          path: reports/penetration-junit.xml
      
      - name: Comment PR with security results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const bandit = JSON.parse(fs.readFileSync('reports/bandit.json', 'utf8'));
            const safety = JSON.parse(fs.readFileSync('reports/safety.json', 'utf8'));
            
            const comment = `## ðŸ”’ Security Scan Results
            
            ### Bandit (Python SAST)
            - **Errors**: ${bandit.results.length}
            - **Severity**: ${JSON.stringify(bandit.metrics._totals)}
            
            ### Safety (Dependency Vulnerabilities)
            - **Vulnerabilities found**: ${safety.results ? safety.results.length : 0}
            
            ðŸ“Š Full reports available in the artifacts.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
